# WebAuthn（パスキー）によるNostr秘密鍵の安全な保管とイベント署名

## 目次

- [概要・背景](#概要背景)
- [パスキーによるNostr秘密鍵管理の実装アプローチ](#パスキーによるnostr秘密鍵管理の実装アプローチ)
- [PRF値を直接利用する方法（推奨）](#prf値を直接利用する方法推奨)
- [暗号化/復号アプローチ（代替手法）](#暗号化復号アプローチ代替手法)
- [ユーザー体験とセキュリティバランス](#ユーザー体験とセキュリティバランス)
- [技術的考慮点とセキュリティ](#技術的考慮点とセキュリティ)
- [まとめと今後の展望](#まとめと今後の展望)

## 概要・背景

Nostrプロトコルではユーザーの身元を識別しイベントに署名するために秘密鍵が必要ですが、この秘密鍵の流出は致命的なセキュリティリスクとなります。多くのNostrクライアントでは秘密鍵をブラウザのローカルストレージに平文で保存したり、パスワード保護形式（NIP-49など）で暗号化して保存する方法が採用されていますが、どちらもセキュリティと利便性の面で課題があります。

WebAuthn（パスキー）は、ユーザー認証をより安全かつシンプルに行うための標準技術です。認証時に生体認証（指紋、顔認証）やセキュリティキー（YubiKeyなど）を使用し、秘密鍵がデバイス内部に安全に保管される特徴があります。この技術を応用してNostrの秘密鍵を安全に管理する方法について説明します。

## パスキーによるNostr秘密鍵管理の実装アプローチ

WebAuthnを使ったNostr秘密鍵管理には、大きく2つのアプローチがあります：

### 推奨アプローチ：PRF値の直接利用（新規ユーザー向け）

WebAuthn Level 3で導入されたPRF拡張（Pseudo-Random Function extension）を活用し、Authenticator内の秘密から導出された値を直接Nostrの秘密鍵として使用します。

**基本的な仕組み**:
1. ユーザーがWebAuthnパスキーを登録
2. PRF拡張で固定の入力（salt）に対する出力値を取得
3. この値を直接Nostrの秘密鍵として使用

**メリット**: シンプル、高速、ライブラリ依存が少ない（ブラウザネイティブAPIのみで実装可能）

### 代替アプローチ：秘密鍵の暗号化/復号（既存鍵インポート向け）

既存のNostr秘密鍵（nsec）をWebAuthnのPRF値を用いて暗号化保存し、署名時に復号して使用します。

**基本的な仕組み**:
1. 既存のNostr秘密鍵をインポートまたは新規生成
2. WebAuthnから得たPRF値で秘密鍵を暗号化して保存
3. 署名時に再認証して秘密鍵を復号し使用

**メリット**: 既存のnsecをインポート可能、複数クライアント間での鍵共有が容易

### アプローチ比較と選択基準

| 比較点 | PRF値直接利用（推奨） | 暗号化/復号アプローチ |
|:------|:-------------------|:-------------------|
| シンプルさ・処理速度 | ★★★★★ | ★★★ |
| 既存鍵のインポート | ✗ サポート不可 | ✓ サポート可能 |
| 実装の複雑さ | 低い | 中程度 |
| 最適なユーザー | 新規ユーザー | 既存鍵を持つユーザー |

新規ユーザーにとってはPRF値を直接利用する方法が**ファーストチョイスとして推奨**されます。

## PRF値を直接利用する方法（推奨）

### 技術的仕組みと実装

WebAuthnのPRF拡張は、Authenticator内部の秘密鍵と提供されたソルトから決定論的な疑似乱数値を生成します。同じクレデンシャルIDと同じソルトなら常に同じ値が得られるため、これをNostrの秘密鍵として利用できます。

**実装の基本ステップ**:

1. WebAuthnパスキーを登録し、PRF拡張を有効化
2. 固定のソルト値を使ってPRF値を取得
3. 取得したPRF値をNostr秘密鍵として使用（公開鍵導出、署名等）
4. 使用後は速やかにメモリから秘密鍵を消去

PRF拡張を使った最小限の実装例：

```javascript
// 1. パスキー登録（PRF拡張有効化）
const credential = await navigator.credentials.create({
  publicKey: {
    // 必要なパラメータ設定...
    extensions: { prf: { eval: {} } }  // PRF拡張を有効化
  }
});

// 2. PRF値取得（署名時）
const assertion = await navigator.credentials.get({
  publicKey: {
    // 必要なパラメータ設定...
    extensions: { prf: { eval: { first: fixedSalt } } }
  }
});
const prfResult = assertion.getClientExtensionResults().prf.results.first;

// 3. PRF値を秘密鍵として使用
const signature = signEvent(event, prfResult);

// 4. 使用後にメモリから消去
prfResult.fill(0);
```

より詳細な実装例については[SDKインターフェース詳細](sdk-if.md)を参照してください。

### 考慮点と制限事項

1. **PRF拡張のサポート状況**: すべてのブラウザやAuthenticatorがサポートしているわけではない（[対応表](prf-support-tables.md)参照）
2. **secp256k1の範囲制約**: PRF出力値が曲線の有効な秘密鍵範囲外となる理論的可能性（約2^-224の確率）
3. **既存鍵との互換性**: nsec鍵のインポート不可
4. **バックアップ/リカバリー**: パスキーのクラウド同期に依存（プラットフォーム依存）
5. **ドメイン制約**: WebAuthnはドメインと紐付くため、異なるドメインのアプリ間で移行できない

## 暗号化/復号アプローチ（代替手法）

既存のNostr秘密鍵（nsec）をWebAuthnのPRF値で暗号化するアプローチです。PRF値を暗号化キーとして直接利用することで、追加の鍵導出（NIP-49のscrypt等）を省略でき、パフォーマンスと安全性のバランスを取れます。

**基本フロー**:
1. 秘密鍵の生成またはインポート
2. PRF値を取得しAES-GCMの鍵として使用
3. 秘密鍵を暗号化してメタデータと共に保存
4. 署名時はPRF値を再取得して復号・署名・消去

このアプローチの最大の利点は既存のnsec鍵をインポートできることです。既存のアイデンティティをパスキーによって保護できます。

## ユーザー体験とセキュリティバランス

### 認証体験と使いやすさ

WebAuthnパスキーを利用したNostr署名フローは、従来のパスワード入力と比較して大幅にUXを向上させます：

- **シンプルなフロー**: ブラウザUI上で生体認証やPIN入力するだけ
- **クロスデバイス**: OSのパスキー同期機能で複数デバイスでも同じ体験
- **直感的操作**: 「投稿を承認」という感覚でOS標準UIに統合

### セキュリティ強度とトレードオフ

**セキュリティ上の利点**:
- 秘密鍵がデバイスのセキュアエレメント内に保存され、マルウェアやキーロガー耐性が向上
- 多要素認証によりセキュリティが強化（持っているもの、知っているもの、生体情報）
- フィッシングサイトでは正規のパスキーが使用不可

**トレードオフ**:
- ブラウザ・デバイスの対応状況による制約
- リカバリー方法はプラットフォームに依存
- プラットフォーム間での移行が複雑になる場合がある

PRF値直接利用はクラウド同期の品質に依存しますが、暗号化/復号アプローチはnsecエクスポート機能でリカバリー選択肢を提供できます。また、PRF値をnsecとしてエクスポートする機能も検討価値があります。

## 技術的考慮点とセキュリティ

### 環境依存性と対応状況

WebAuthnとPRF拡張の対応状況は環境によって異なります。詳細は[PRF対応表](prf-support-tables.md)を参照してください。PRF拡張が利用できない場合は、代替アプローチ（HMAC-secret拡張、NIP-49など）を提供すべきです。

### セキュリティ上の考慮点

1. **パスキーの同期と保管**:
   - 同期パスキー: 利便性が高いがプラットフォームの同期品質に依存
   - デバイスバウンド鍵: セキュリティが高いが紛失リスクあり

2. **NIP-49互換性**:
   - PRF値は既に高エントロピーなため、NIP-49のscrypt処理は冗長
   - ブラウザネイティブの暗号化（AES-GCM等）の方が効率的

3. **セキュリティベストプラクティス**:
   - ユーザー検証（UV）の必須化: `userVerification: "required"`
   - メモリからの秘密鍵の即時消去
   - CSP設定によるXSS対策

## まとめと今後の展望

WebAuthnパスキーとPRF拡張を活用したNostr秘密鍵管理は、セキュリティとユーザー体験の両面で大きな改善をもたらします。特に新規ユーザーにとって、PRF値直接利用アプローチはシンプルで高速かつセキュアなファーストチョイスです。

**主な結論**:
1. PRF値直接利用は新規ユーザーに最適な選択肢
2. 環境に応じたフォールバックメカニズムを備えた実装が理想的
3. パスキーはパスワードレス体験と高いセキュリティを両立

この実装アプローチにより、一般ユーザーでも容易に高いセキュリティを実現しながら、Nostrのエコシステムに参加することが可能になります。

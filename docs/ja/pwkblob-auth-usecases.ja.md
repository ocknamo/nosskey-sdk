# Nosskeyにおけるユーザー認証のユースケースとPWKBlob概念

## 1. PWKBlobの概念と実装方式

PWKBlob（Passkey Wrapped Key Blob）はNosskeyの中核技術概念であり、パスキー認証とNostr秘密鍵管理を橋渡しするデータ構造です。現在以下の2つの実装方式があります：

1. **暗号化方式（PWKBlobEncrypted）**: 
   - Nostr秘密鍵をパスキー由来の鍵で暗号化して保存
   - **PWKBlobの喪失は秘密鍵の完全な紛失に当たり、復元は不可能**
   - **対策として秘密鍵のバックアップやリレーへの保存方法の検討が必要**

2. **PRF直接使用方式（PWKBlobDirect）**: 
   - パスキーのPRF拡張から直接Nostr秘密鍵を導出
   - PWKBlobDirectには使用方式とcredentialIdのみ含まれる
   - 同じパスキーと同じsaltから常に同一の秘密鍵が生成される
   - PWKBlobが失われても、同じパスキーで再認証するだけで秘密鍵を復元可能

```mermaid
graph TD
    subgraph "PWKBlob実装方式"
        V1[暗号化方式] -->|秘密鍵を暗号化| PWK1[PWKBlob Encrypted]
        PWK1 -->|復号| SK1[Nostr秘密鍵]
        PWK1 -.->|喪失| Lost[秘密鍵完全喪失]
        
        Direct[PRF直接使用方式] -->|PRF値から直接導出| PWK2[PWKBlob Direct]
        PWK2 -.->|参照情報のみ保持| ID[credentialId]
        Passkey[同じパスキー] -->|PRF拡張| PRF[PRF値]
        PRF -->|変換| SK2[Nostr秘密鍵]
        PWK2 -.->|喪失しても| Restore[同じパスキーで復元可能]
    end
```

## 2. 秘密鍵の復元メカニズム（PRF直接使用方式）

```mermaid
sequenceDiagram
    participant ユーザー
    participant アプリ
    participant NosskeySDK
    participant 認証器
    participant LocalStorage

    Note over ユーザー,LocalStorage: シナリオ: PWKBlobが失われた状態（デバイス変更など）

    ユーザー->>アプリ: アプリにアクセス
    アプリ->>LocalStorage: PWKBlob確認
    LocalStorage-->>アプリ: PWKBlobなし
    アプリ->>ユーザー: 未認証状態を表示

    ユーザー->>アプリ: 既存パスキーでログイン選択
    アプリ->>NosskeySDK: パスキーログイン要求(username)
    
    NosskeySDK->>認証器: PRF拡張を含む認証要求
    認証器->>ユーザー: 物理認証を要求（タッチ/PIN等）
    ユーザー->>認証器: 認証完了
    認証器-->>NosskeySDK: PRF値を含む認証結果
    
    NosskeySDK->>NosskeySDK: PRF値からNostr鍵生成
    NosskeySDK->>NosskeySDK: PWKBlobDirect作成
    NosskeySDK-->>アプリ: PWKBlobDirectと公開鍵を返却
    アプリ->>LocalStorage: PWKBlobDirectを保存
    アプリ->>ユーザー: 認証完了・同一アカウントへアクセス
    
    Note over ユーザー,LocalStorage: 署名操作時のフロー
    
    ユーザー->>アプリ: Nostrメッセージ投稿
    アプリ->>LocalStorage: PWKBlobDirect取得
    LocalStorage-->>アプリ: PWKBlobDirect
    アプリ->>NosskeySDK: イベント署名要求(PWKBlobDirect, 未署名イベント)
    NosskeySDK->>認証器: 認証要求（必要に応じて）
    認証器->>ユーザー: 物理認証（必要に応じて）
    ユーザー->>認証器: 認証完了
    認証器-->>NosskeySDK: PRF値
    NosskeySDK->>NosskeySDK: 秘密鍵再生成
    NosskeySDK->>NosskeySDK: イベント署名
    NosskeySDK-->>アプリ: 署名済みイベント
    アプリ->>ユーザー: 投稿完了
```

## 3. PWKBlobDirectのメリット

PWKBlobDirectの主な利点は以下の通りです：

1. **復元の容易さ**: 
   - 秘密鍵は明示的に保存されず、パスキー認証時に都度生成される
   - 同じパスキーと同じsaltから常に同じPRF値が得られるため、デバイス変更やlocalStorageクリア後も同じ鍵が復元可能

2. **UX向上**: 
   - PWKBlobDirectがあれば認証方式やパスキーの種類を選択する必要がなく、ユーザー操作が単純化される
   - 秘密鍵バックアップ管理の負担がなくなる（パスキー自体の管理のみが必要）

3. **セキュリティ**: 
   - 秘密鍵がストレージに永続保存されないため、漏洩リスクが軽減される
   - 鍵の生成・使用はパスキー認証の一環として行われるため、認証と署名が一体化

## 4. ユーザー認証のユースケース

### 4.1 ユースケース図

```mermaid
graph TD
  subgraph "ユーザー認証のユースケース"
    User((ユーザー))
    
    UC1[初回登録（新規パスキー作成）]
    UC2[既存パスキーでログイン]
    UC3[通常ログアウト]
    UC4[ブラウザデータクリアによるログアウト]
    UC5[デバイス変更時のアカウント復元]
    UC6[アプリ再訪問時の自動認証]
    UC7[PRF拡張対応確認]
    UC8[キャッシュ設定変更]
    
    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC6
    User --> UC7
    User --> UC8
  end
```

### 4.2 ユースケース詳細

#### 4.2.1 初回登録（新規パスキー作成）
- **アクター**: ユーザー
- **説明**: 初めてアプリを使用するユーザーが新規パスキーを作成し、Nostrアカウントを設定
- **基本フロー**:
  1. ユーザーがPRF拡張対応確認ボタンをクリック
  2. アプリがNosskeySDK経由でPRF拡張対応を確認（確認のためにパスキーの作成が必要なのでこのステップは省略してよい）
  3. PRF拡張対応が確認されたら「新規パスキー作成」ボタンをクリック
  4. ユーザー名を入力
  5. NosskeySDKが認証器との通信を処理
  6. 認証器で認証
  7. パスキーが作成される
  8. パスキー作成時はPRF値は生成されないため再度「初回ログイン」ボタンをクリック
  9. NosskeySDKがPRF値からNostr鍵を生成し、PWKBlobDirectを作成
  10. アプリがPWKBlobDirectをlocalStorageに保存
  11. アカウント画面へ自動遷移

#### 4.2.2 既存パスキーでログイン
- **アクター**: ユーザー
- **説明**: 既に作成したパスキーを使用してログイン
- **基本フロー**:
  1. 「既存パスキーでログイン」ボタンをクリック
  2. プラットフォームのUIで自分が登録したパスキーを選択
  3. NosskeySDKが認証処理と認証器通信を実行
  4. 認証器で認証
  5. NosskeySDKがPRF値からNostr鍵を生成し、PWKBlobDirectを作成
  6. SDKがPWKBlobDirectをアプリに返却しする
  7. アプリかもしくはSDK自体がPWKをlocalStorageに保存
  8. アカウント画面へ自動遷移

#### 4.2.3 通常ログアウト
- **アクター**: ユーザー
- **説明**: アプリ内の機能を使用して明示的にログアウト
- **前提条件**: 認証済み状態
- **基本フロー**:
  1. ログアウトボタンをクリック
  2. 状態をリセット（PWKBlobなどをクリア）
  3. アカウント画面へ遷移（未認証状態）

#### 4.2.4 ブラウザデータクリアによるログアウト
- **アクター**: ユーザー
- **説明**: ブラウザのlocalStorageをクリアすることによる非明示的なログアウト
- **前提条件**: 認証済み状態
- **基本フロー**:
  1. ブラウザの設定からlocalStorageをクリア
  2. アプリ再訪問時に未認証状態となる

#### 4.2.5 デバイス変更時のアカウント復元
- **アクター**: ユーザー
- **説明**: 新デバイスでも同じNostrアカウントを復元
- **前提条件**: 同じパスキー（クラウドバックアップされたプラットフォーム認証器か物理認証器）を所有
- **基本フロー**:
  1. 新デバイスでアプリにアクセス（PWKBlobなし）
  2. 「既存パスキーでログイン」を選択
  3. **元と同じユーザー名を入力**（重要）
  4. 同じ認証器で認証
  5. 同一のPRF値が生成され、同一のNostr鍵ペアが導出される
  6. 元のNostr公開鍵でアカウントが復活（リレーからプロフィール等を再取得）

#### 4.2.6 アプリ再訪問時の自動認証
- **アクター**: ユーザー
- **説明**: 一度認証済みのユーザーがブラウザを閉じた後に再度アクセスした場合
- **前提条件**: 過去に認証済みでlocalStorageにPWKBlobが保存されている
- **基本フロー**:
  1. アプリ起動時にlocalStorageをチェック
  2. PWKBlobが存在する場合、自動的に認証状態に設定
  3. アカウント画面が表示される

#### 4.2.7 Nostrイベント署名プロセス
- **アクター**: ユーザー
- **説明**: アプリ内でのNostrイベント（投稿など）の署名
- **基本フロー**:
  1. ユーザーが投稿内容を入力し送信
  2. SDKがlocalStorageからPWKBlobDirectを取得
  3. アプリがNosskeySDKに未署名イベントを渡して署名要求
  4. NosskeySDKが認証器との通信を処理（必要に応じて再認証）
  5. PRF値から秘密鍵を再生成し、SDK内部でイベント署名
  6. 署名済みイベントがアプリに返却され、リレーに送信

## 5. PWKBlobとNostr秘密鍵の関係（PWKBlobEncrypted vs PWKBlobDirect）

| 特性 | PWK暗号化方式 | PRF直接使用方式 |
|------|-----------------|-----------------|
| 秘密鍵の保存方法 | 暗号化されて保存 | 保存せず、都度生成 |
| PWKBlobの中身 | 暗号化された秘密鍵 | 方式情報とcredentialIdのみ |
| PWKBlob紛失時 | **秘密鍵完全喪失（復元不可能）** | 同じパスキーで完全復元可能 |
| リスク対策 | **バックアップやリレー保存の検討が必要** | パスキー自体の管理のみ |
| セキュリティ特性 | 秘密鍵は暗号化されるが存在 | 秘密鍵は一時的にのみ生成 |
| UX特性 | 認証のみで完結 | 認証のみで完結 |
| SDKの役割 | PRF値による秘密鍵の暗号化・復号化、署名処理を内部で実行 | PRF値から鍵生成、署名処理を内部で完結 |

## 6. アプリケーションとSDKの責務分担

NosskeySDKは以下の責務を担い、アプリケーションから複雑な処理を抽象化しています：

1. **認証器との通信**: 
   - WebAuthn APIの複雑な呼び出しをラップ
   - PRF拡張のリクエスト処理
   - 認証器との全ての通信を処理

2. **PWKBlobの処理**:
   - PWKBlobの作成・検証・基本的な保管（localStorage）
   - PWKBlobの形式管理
   - **※PWKBlobの複数保管・取得などの複雑なアカウント管理はアプリ側の責任**

3. **Nostr鍵の処理**:
   - PRF値からNostr鍵への変換
   - 秘密鍵の安全な管理（メモリ上での一時的保持）
   - イベント署名の内部処理

4. **状態管理の補助**:
   - 鍵のキャッシュ管理（オプション）

アプリケーション側は以下を担当します：

1. **UI/UX**: 
   - ユーザーインターフェースの提供
   - 認証状態に応じた画面表示

2. **データ永続化**:
   - **PWKBlobの複数保管・取得などの複雑なアカウント管理**
   - 他のアプリケーションデータの管理
   - PWKBlobEncryptedのリレーへのバックアップ処理

3. **認証状態管理**:
   - PWKBlobの有無に基づく認証状態の判定

4. **ビジネスロジック**:
   - Nostrイベントの作成
   - リレーとの通信

## 7. 復元のユニークポイント

Nosskeyの最も特徴的な点は、**「秘密鍵をバックアップしなくても、同じパスキーと同じsaltがあれば完全に同一のNostrアカウントを復元できる」**という点です。これはPRF拡張の特性を活かしたアーキテクチャで、従来の秘密鍵管理の課題（バックアップ、漏洩リスク）を解決しています。

ユーザーにとっては「パスキー（物理認証器）さえ持っていれば、どのデバイスからでも自分のNostrアカウントにアクセスできる」という直感的なメンタルモデルを提供し、UXを大幅に向上させています。

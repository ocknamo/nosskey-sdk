NIP-XX  
パスキー由来Nostr鍵（Passkey-Derived Nostr Keys）
==========================

`draft` `optional`

このNIPは、WebAuthnパスキー（FIDO2/WebAuthn認証情報）のPRF拡張を使用してNostr秘密鍵を直接導出する方法を定義します。パスキーを使用することで、秘密鍵のバックアップや複雑なパスワード管理が不要になり、生体認証や物理デバイスをタッチするだけの直感的な操作でNostrを使用できるようになります。

## WebAuthn PRF拡張について

WebAuthnのPRF（Pseudo-Random Function）拡張は、WebAuthn Level 3仕様で導入された機能です。この拡張は、認証器（セキュリティキーやプラットフォーム認証器）の内部秘密鍵と提供されたソルトから決定論的な疑似乱数値を生成します。

PRF拡張の主な特徴：
- 認証器内部の秘密鍵を使って32バイトの高エントロピー値を生成
- 同じ認証情報（credentialId）と同じソルトからは常に同一のPRF値が得られる
- 値はデバイスの外部に漏れることなく、認証時のみ取得可能

### PRFのサポート状況

PRF拡張の利用可否は、ブラウザだけでなく認証器側の対応にも依存する。PRF拡張をフルに活用するには、以下の3層すべてが対応している必要がある:

- 認証器（ハードウェア/プラットフォーム）
- OS（認証APIレイヤ）
- ブラウザ

主要なOSとブラウザは対応していますが、一部の主要な認証器ではまだ対応されていないため、クライアント実装者は既存の認証方法へのフォールバックを実装することが推奨される。

参考: [PRFサポート状況](https://github.com/ocknamo/nosskey-sdk/blob/main/docs/en/prf-support-tables.en.md)

### PRF値をNostr秘密鍵として使用する条件

PRF拡張から取得した32バイトの値をNostr秘密鍵として使用するにはsecp256k1の有効な秘密鍵範囲（1からn-1まで、nは曲線の位数）内である必要がある。
範囲チェックを行い範囲外の場合は再生成または調整処理を行うことが推奨されるが、範囲外となる理論的確率は約2^-224と極めて低いため実用上は範囲チェックは省略可能である。

## PRF直接使用方式

この方式では、**秘密鍵は明示的に保存されません**。代わりに、署名が必要な時にパスキーから得られるPRF値から秘密鍵を一時的に導出します。同じパスキーと同じsaltからは常に同じNostr鍵が生成されるため、キー情報が失われても同じパスキーで復元可能です。

### データ構造

パスキーとの関連付けに必要な最小限の情報のみを保持します：

```jsonc
{
  "credentialId": "a3f5b8c12d...9f",  // パスキーの識別子（hex形式）
  "pubkey": "02ab34cd56...ef", // Nostr公開鍵（hex形式）
  "salt": "6e6f7374722d6b6579", // PRF導出用のsalt（hex形式、固定値）
  "username": "alice" // パスキー作成時のユーザー名（オプション）
}
```

### Salt値の仕様

同じNostr鍵を生成するため、実装間でsalt値を統一する必要があります。標準のsalt値：

```
"nostr-key" (UTF-8バイト: 0x6e6f7374722d6b6579)
```

## セキュリティ上の留意事項

パスキー自体の署名の仕組みとは異なり、Nostrイベントの署名のために秘密鍵を一時的にクライアントアプリ内部で復号化する必要がある。UXとのバランスを取った上で、不要な場合は速やかにメモリから秘密鍵を消去するべきです。
